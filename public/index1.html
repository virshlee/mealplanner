<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Meal Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
	<!-- Firebase App (core SDK) -->
	<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>

		<!-- Firebase Authentication -->
		<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
	<script>
	  // Replace with your Firebase project settings
	  const firebaseConfig = {
		apiKey: "AIzaSyB5Dle95t_pZFHMJ0nHLK0Stmv4CyFkpSI",
		authDomain: "mealplanner-3d711.firebaseapp.com",
		projectId: "mealplanner-3d711",
		storageBucket: "mealplanner-3d711.firebasestorage.app",
		messagingSenderId: "731814301235",
		appId: "1:731814301235:web:b652ad6e9fc06c93141d46"
	  };

	  // Initialize Firebase
	  firebase.initializeApp(firebaseConfig);
	</script>
		
	<input type="text" id="email" placeholder="Email">
	<input type="password" id="password" placeholder="Password">
	<button id="loginBtn">Log In</button>
	<button id="signupBtn">Sign Up</button>
	<div id="status"></div>
		
		
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-50 text-gray-800 transition-colors duration-300;
            user-select: none;
        }

        /* Custom toggle switch for metric/imperial units */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .calendar-day-cell {
            @apply w-10 h-10 flex items-center justify-center rounded-lg cursor-pointer transition-all duration-200;
        }

        .calendar-day-cell:not(.selected):hover {
            @apply bg-gray-200;
        }

        .calendar-day-cell.selected {
            @apply bg-blue-600 text-white font-bold;
        }

        .calendar-day-cell.range-selected {
            @apply bg-blue-400 text-white;
        }

        .calendar-day-cell.faded {
            @apply text-gray-400 cursor-default hover:bg-transparent;
        }

        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            transition: background .2s, box-shadow .2s;
        }
        .custom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            transition: background .2s, box-shadow .2s;
        }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-6">
    <div class="w-full max-w-4xl mx-auto space-y-8">
        <header class="bg-white rounded-2xl p-6 shadow-md border border-gray-200 text-center flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="text-center sm:text-left">
                <h1 class="text-4xl font-extrabold text-blue-600 mb-2">My Meal Planner</h1>
                <p class="text-gray-500 max-w-2xl mx-auto">
                    Generate a custom meal plan and get a copiable grocery list.
                </p>
            </div>
            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <div>
                    <p class="text-sm text-gray-500">
                        This is a self-contained, offline version.
                    </p>
                </div>
            </div>
        </header>

        <section class="bg-white rounded-2xl p-6 shadow-md border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Recipe Catalog</h2>
            <div id="recipeCatalogContainer" class="max-h-[600px] overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-700 mb-3">Breakfast</h3>
                        <div id="breakfastRecipes" class="space-y-2">
                            <p class="text-sm text-gray-400">No breakfast recipes added yet.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-700 mb-3">Dinner</h3>
                        <div id="dinnerRecipes" class="space-y-2">
                            <p class="text-sm text-gray-400">No dinner recipes added yet.</p>
                        </div>
                    </div>
                    <div id="userRecipesSection" class="col-span-1 md:col-span-2 lg:col-span-1">
                        <h3 class="text-xl font-bold text-gray-700 mb-3">Your Recipes</h3>
                        <div id="userRecipesList" class="space-y-2">
                            <p class="text-sm text-gray-400">No user recipes added yet.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 pt-4 border-t border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Add Recipe from URL</h3>
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <label for="recipeUrl" class="sr-only">Recipe URL</label>
                    <input type="url" id="recipeUrl" placeholder="Enter a recipe URL (e.g., 'https://www.allrecipes.com/recipe/...')"
                                 class="flex-grow w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="addRecipeBtn"
                                 class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md
                                         hover:bg-blue-700 transition-colors duration-200 transform active:scale-95">
                        Add Recipe
                    </button>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-2xl p-6 shadow-md border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Generate Meal Plan</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label for="portions" class="text-lg font-medium text-gray-700 whitespace-nowrap">Portions:</label>
                    <input type="number" id="portions" value="4" min="1"
                        class="w-20 p-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-lg font-medium text-gray-700">Imperial</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="metricToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="text-lg font-medium text-gray-700">Metric</span>
                </div>
            </div>
            <div id="calendarSection" class="mt-6 flex flex-col items-center">
                <div class="flex items-center justify-between w-full max-w-sm mb-4">
                    <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h3 id="monthYearDisplay" class="text-xl font-bold text-gray-800"></h3>
                    <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-7 gap-2 text-center w-full max-w-sm">
                    <div class="text-sm font-semibold text-gray-500">Sun</div>
                    <div class="text-sm font-semibold text-gray-500">Mon</div>
                    <div class="text-sm font-semibold text-gray-500">Tue</div>
                    <div class="text-sm font-semibold text-gray-500">Wed</div>
                    <div class="text-sm font-semibold text-gray-500">Thu</div>
                    <div class="text-sm font-semibold text-gray-500">Fri</div>
                    <div class="text-sm font-semibold text-gray-500">Sat</div>
                    <div id="calendarDaysGrid" class="col-span-7 grid grid-cols-7 gap-2"></div>
                </div>
            </div>
            <button id="generateBtn"
                class="w-full sm:w-auto mt-6 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md
                                         hover:bg-blue-700 transition-colors duration-200 transform active:scale-95 mx-auto block">
                Generate Meal Plan
            </button>
        </section>

        <div id="outputSection" class="hidden space-y-8">
            <section class="bg-white rounded-2xl p-6 shadow-md border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Your Meal Plan</h2>
                <div id="mealPlanContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            </section>

            <section class="bg-white rounded-2xl p-6 shadow-md border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Next Steps</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Grocery List</h3>
                        <div class="relative">
                            <textarea id="groceryListArea" rows="10" readonly
                                class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-sm text-gray-700
                                         resize-none focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                            <button id="copyBtn"
                                class="absolute top-2 right-2 p-2 bg-green-500 text-white rounded-md shadow-md
                                         hover:bg-green-600 transition-colors duration-200" title="Copy to clipboard">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3h3V2a2 2 0 012-2h2a2 2 0 012 2v16a2 2 0 01-2 2H6a2 2 0 01-2-2V5a2 2 0 012-2zM12 9a1 1 0 011-1h3a1 1 0 110 2h-3a1 1 0 01-1-1z" />
                                </svg>
                            </button>
                            <div id="copyMessage" class="absolute bottom-2 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded-md opacity-0 transition-opacity duration-300">
                                Copied to clipboard!
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Add to Calendar</h3>
                        <p class="text-sm text-gray-600">Download a calendar file to import into your preferred app.</p>
                        <button id="downloadCalendarBtn"
                                         class="w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md
                                                 hover:bg-blue-600 transition-colors duration-200 transform active:scale-95">
                            Download Calendar File
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <div id="messageModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-xs text-center">
                <p id="messageText" class="text-lg font-medium mb-4 text-gray-800"></p>
                <button onclick="document.getElementById('messageModal').classList.add('hidden')"
                        class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    OK
                </button>
            </div>
        </div>

        <div id="confirmModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm text-center">
                <p id="confirmText" class="text-lg font-medium mb-6 text-gray-800">Are you sure you want to delete this recipe?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmYes" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200">Yes, Delete</button>
                    <button id="confirmNo" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200">No, Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Static Recipes (Client-Side Only) ---
        const staticRecipes = [];
        
        // --- Unit Conversion Map ---
        const unitMap = {
            'cup': 236.6, 'cups': 236.6,
            'tablespoon': 14.8, 'tbsp': 14.8, 'T': 14.8,
            'teaspoon': 4.9, 'tsp': 4.9,
            'fluid ounce': 29.6, 'fl oz': 29.6, 'oz': 28.35,
            'pound': 453.6, 'lb': 453.6,
            'pint': 473.2, 'pt': 473.2,
            'quart': 946.4, 'qt': 946.4,
            'gallon': 3785.4, 'gal': 3785.4,
        };

        const unitMapMetric = {
            'cup': 'ml', 'cups': 'ml',
            'tablespoon': 'ml', 'tbsp': 'ml', 'T': 'ml',
            'teaspoon': 'ml', 'tsp': 'ml',
            'fluid ounce': 'ml', 'fl oz': 'ml',
            'ounce': 'g', 'oz': 'g',
            'pound': 'g', 'lb': 'g',
            'pint': 'ml', 'pt': 'ml',
            'quart': 'ml', 'qt': 'ml',
            'gallon': 'ml', 'gal': 'ml',
        };

        let allRecipes = [...staticRecipes];
        let userRecipes = [];
        let generatedGroceryList = {};
        let generatedMealPlan = [];
        
        // Calendar State (now managed by the new calendar JS)
        let startDate = null;
        let endDate = null;

        // --- UI Element References ---
        const portionsInput = document.getElementById('portions');
        const generateBtn = document.getElementById('generateBtn');
        const outputSection = document.getElementById('outputSection');
        const mealPlanContainer = document.getElementById('mealPlanContainer');
        const groceryListArea = document.getElementById('groceryListArea');
        const copyBtn = document.getElementById('copyBtn');
        const copyMessage = document.getElementById('copyMessage');
        const recipeUrlInput = document.getElementById('recipeUrl');
        const addRecipeBtn = document.getElementById('addRecipeBtn');
        const metricToggle = document.getElementById('metricToggle');
        const breakfastRecipesContainer = document.getElementById('breakfastRecipes');
        const dinnerRecipesContainer = document.getElementById('dinnerRecipes');
        const userRecipesListContainer = document.getElementById('userRecipesList');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const confirmModal = document.getElementById('confirmModal');
        const confirmYesBtn = document.getElementById('confirmYes');
        const confirmNoBtn = document.getElementById('confirmNo');
        const downloadCalendarBtn = document.getElementById('downloadCalendarBtn');
        
        // New calendar element references
        const calendarDaysGrid = document.getElementById("calendarDaysGrid");
        const monthYearDisplay = document.getElementById("monthYearDisplay");
        const prevMonthBtn = document.getElementById("prevMonthBtn");
        const nextMonthBtn = document.getElementById("nextMonthBtn");

        // New calendar state variables
        let currentDate = new Date();
        let viewYear = currentDate.getFullYear();
        let viewMonth = currentDate.getMonth();

        // Function to show a custom message modal instead of alert()
        function showMessage(text, colorClass = "text-gray-800") {
            messageText.textContent = text;
            messageText.className = `text-lg font-medium mb-4 ${colorClass}`;
            messageModal.classList.remove('hidden');
        }

        function createRecipeCheckbox(recipe, canDelete = false) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 py-1 text-sm';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `recipe-${recipe.id}`;
            checkbox.value = recipe.id;
            checkbox.className = 'h-4 w-4 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500';

            const recipeNameSpan = document.createElement('span');
            recipeNameSpan.className = 'flex-grow cursor-pointer hover:text-blue-600 transition-colors';
            recipeNameSpan.textContent = recipe.name;
            recipeNameSpan.addEventListener('click', (e) => {
                e.stopPropagation();
                if (recipe.url) {
                    window.open(recipe.url, '_blank');
                } else {
                    showMessage(`Recipe: ${recipe.name}\nIngredients: ${recipe.ingredients.join(', ')}`);
                }
            });

            div.appendChild(checkbox);
            div.appendChild(recipeNameSpan);

            if (canDelete) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700 transition-colors duration-200';
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                `;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirm(`Are you sure you want to delete "${recipe.name}"?`, () => deleteRecipe(recipe.id));
                });
                div.appendChild(deleteBtn);
            }
            return div;
        }

        function renderCatalog() {
            const breakfastRecipes = allRecipes.filter(r => r.mealType === 'breakfast');
            const dinnerRecipes = allRecipes.filter(r => r.mealType === 'dinner');
            
            breakfastRecipesContainer.innerHTML = '';
            dinnerRecipesContainer.innerHTML = '';
            userRecipesListContainer.innerHTML = '';

            if (breakfastRecipes.length === 0) {
                 breakfastRecipesContainer.innerHTML = '<p class="text-sm text-gray-400">No breakfast recipes added yet.</p>';
            } else {
                breakfastRecipes.forEach(recipe => {
                    breakfastRecipesContainer.appendChild(createRecipeCheckbox(recipe));
                });
            }
            
            if (dinnerRecipes.length === 0) {
                dinnerRecipesContainer.innerHTML = '<p class="text-sm text-gray-400">No dinner recipes added yet.</p>';
            } else {
                dinnerRecipes.forEach(recipe => {
                    dinnerRecipesContainer.appendChild(createRecipeCheckbox(recipe));
                });
            }

            if (userRecipes.length === 0) {
                userRecipesListContainer.innerHTML = '<p class="text-sm text-gray-400">No user recipes added yet.</p>';
            } else {
                userRecipes.forEach(recipe => {
                    userRecipesListContainer.appendChild(createRecipeCheckbox(recipe, true));
                });
            }
        }

        // --- Event Handlers ---
		// Get references to the email and password inputs, and the sign in and sign up buttons
		var email = document.getElementById("email");
		var password = document.getElementById("password");
		var signInButton = document.getElementById("signInButton");
		var signUpButton = document.getElementById("signUpButton");

		// Add event listeners to the sign in and sign up buttons
		loginBtn.addEventListener("click", function() {
		  // Sign in the user using Firebase's signInWithEmailAndPassword method
		  firebase.auth().signInWithEmailAndPassword(email.value, password.value)
			.then(function() {
			  // Redirect the user to the protected resources page
			  window.location.href = "/protected-resources.html";
			})
			.catch(function(error) {
			  // Show an error message
			  alert(error.message);
			});
		});

		signUpButton.addEventListener("click", function() {
		  // Sign up the user using Firebase's createUserWithEmailAndPassword method
		  firebase.auth().createUserWithEmailAndPassword(email.value, password.value)
			.then(function() {
			  // Redirect the user to the protected resources page
			  window.location.href = "/protected-resources.html";
			})
			.catch(function(error) {
			  // Show an error message
			  alert(error.message);
			});
		});
		
        addRecipeBtn.addEventListener('click', () => {
            const url = recipeUrlInput.value.trim();
            if (url) {
                const newRecipe = {
                    id: `user-${Date.now()}`,
                    name: url,
                    ingredients: [],
                    portions: 1,
                    mealType: 'dinner',
                    url: url,
                };
                userRecipes.push(newRecipe);
                allRecipes = [...staticRecipes, ...userRecipes];
                renderCatalog();
                recipeUrlInput.value = '';
                showMessage('Recipe URL added successfully!', 'text-green-600');
            } else {
                showMessage('Please enter a valid recipe URL.', 'text-red-600');
            }
        });
		
		

        // --- Other functions (unchanged) ---

        // Function to show a custom confirmation modal
        function showConfirm(text, onConfirm) {
            confirmText.textContent = text;
            confirmModal.classList.remove('hidden');
            confirmYesBtn.onclick = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
            };
            confirmNoBtn.onclick = () => {
                confirmModal.classList.add('hidden');
            };
        }

        function deleteRecipe(id) {
            userRecipes = userRecipes.filter(r => r.id !== id);
            allRecipes = [...staticRecipes, ...userRecipes];
            renderCatalog();
            showMessage('Recipe deleted successfully.', 'text-red-600');
        }

        function generateGroceryList(mealPlan, portions, isMetric) {
            const list = {};
            mealPlan.forEach(entry => {
                const recipe = allRecipes.find(r => r.id === entry.recipeId);
                if (recipe) {
                    const servingRatio = portions / recipe.portions;
                    recipe.ingredients.forEach(ingredient => {
                        const parts = ingredient.match(/^(\d*\.?\d*)\s*([a-zA-Z\s.]*)\s*(.*)$/);
                        if (parts) {
                            let [, quantityStr, unit, item] = parts;
                            let quantity = parseFloat(quantityStr);
                            unit = unit.trim().toLowerCase();
                            item = item.trim();

                            if (isNaN(quantity)) {
                                quantity = 1; // Assume 1 if no number is present
                            }

                            quantity = quantity * servingRatio;

                            if (isMetric) {
                                if (unitMap[unit]) {
                                    quantity = (quantity * unitMap[unit]).toFixed(1);
                                    unit = unitMapMetric[unit];
                                }
                            }

                            const key = `${item} (${unit})`;
                            if (list[key]) {
                                list[key] += parseFloat(quantity);
                            } else {
                                list[key] = parseFloat(quantity);
                            }
                        } else {
                            if (list[ingredient]) {
                                list[ingredient] += 1;
                            } else {
                                list[ingredient] = 1;
                            }
                        }
                    });
                }
            });

            const formattedList = Object.keys(list).sort().map(key => {
                const parts = key.match(/^(.*) \((.*)\)$/);
                if (parts) {
                    const [, item, unit] = parts;
                    let quantity = list[key];
                    if (unit.match(/ml|g/)) {
                        quantity = Math.round(quantity);
                    } else {
                        quantity = quantity.toFixed(1).replace(/\.0+$/, '');
                    }
                    return `${item}: ${quantity} ${unit}`;
                } else {
                    return key; // For items with no quantity/unit
                }
            });

            return formattedList.join('\n');
        }

        generateBtn.addEventListener('click', () => {
            if (!startDate || !endDate) {
                showMessage("Please select a date range on the calendar first!");
                return;
            }

            const numDays = (endDate - startDate) / (1000 * 60 * 60 * 24) + 1;
            const selectedRecipes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(el => allRecipes.find(r => r.id === el.value))
                .filter(r => r);

            if (selectedRecipes.length === 0) {
                showMessage("Please select at least one recipe to generate a meal plan.");
                return;
            }

            generatedMealPlan = [];
            mealPlanContainer.innerHTML = '';
            
            const selectedBreakfasts = selectedRecipes.filter(r => r.mealType === 'breakfast');
            const selectedDinners = selectedRecipes.filter(r => r.mealType === 'dinner');
            
            if (selectedBreakfasts.length === 0 || selectedDinners.length === 0) {
                 showMessage("Please select at least one breakfast and one dinner recipe.");
                 return;
            }

            const portions = portionsInput.value;
            const isMetric = metricToggle.checked;

            for (let i = 0; i < numDays; i++) {
                const day = new Date(startDate);
                day.setDate(day.getDate() + i);
                
                const randomBreakfast = selectedBreakfasts[Math.floor(Math.random() * selectedBreakfasts.length)];
                const randomDinner = selectedDinners[Math.floor(Math.random() * selectedDinners.length)];

                const dayPlan = {
                    date: day,
                    breakfast: { ...randomBreakfast, id: `${randomBreakfast.id}-${i}-b` },
                    dinner: { ...randomDinner, id: `${randomDinner.id}-${i}-d` }
                };
                generatedMealPlan.push(dayPlan);
                
                const dayCard = document.createElement('div');
                dayCard.className = 'bg-white p-4 rounded-lg shadow-inner border border-gray-100';
                dayCard.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2 text-gray-800">${day.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</h3>
                    <div class="space-y-2">
                        <div class="bg-gray-100 p-3 rounded-md">
                            <h4 class="font-medium text-gray-700">Breakfast:</h4>
                            <a href="${randomBreakfast.url}" target="_blank" class="text-blue-600 hover:underline">${randomBreakfast.name}</a>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-md">
                            <h4 class="font-medium text-gray-700">Dinner:</h4>
                            <a href="${randomDinner.url}" target="_blank" class="text-blue-600 hover:underline">${randomDinner.name}</a>
                        </div>
                    </div>
                `;
                mealPlanContainer.appendChild(dayCard);
            }

            generatedGroceryList = generateGroceryList(generatedMealPlan.flatMap(d => [{ recipeId: d.breakfast.id }, { recipeId: d.dinner.id }]), portions, isMetric);
            groceryListArea.value = generatedGroceryList;

            outputSection.classList.remove('hidden');
            outputSection.scrollIntoView({ behavior: 'smooth' });
        });
        
        copyBtn.addEventListener('click', () => {
            groceryListArea.select();
            document.execCommand('copy');
            copyMessage.classList.remove('opacity-0');
            setTimeout(() => copyMessage.classList.add('opacity-0'), 2000);
        });
        
        downloadCalendarBtn.addEventListener('click', () => {
            if (generatedMealPlan.length === 0) {
                showMessage("Please generate a meal plan first!");
                return;
            }

            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Meal Planner//NONSGML v1.0//EN\n";

            generatedMealPlan.forEach(dayPlan => {
                const dateStr = dayPlan.date.toISOString().split('T')[0].replace(/-/g, '');
                
                const formatEvent = (recipe, mealTime) => {
                    icsContent += "BEGIN:VEVENT\n";
                    icsContent += `UID:${dayPlan.date.getTime()}-${recipe.id}\n`;
                    icsContent += `DTSTART;VALUE=DATE:${dateStr}\n`;
                    icsContent += `SUMMARY:${mealTime}: ${recipe.name}\n`;
                    if (recipe.url) {
                         icsContent += `URL:${recipe.url}\n`;
                    }
                    icsContent += `DESCRIPTION:Planned meal for today. Check the website for details.\n`;
                    icsContent += "END:VEVENT\n";
                };

                formatEvent(allRecipes.find(r => r.id === dayPlan.breakfast.id), "Breakfast");
                formatEvent(allRecipes.find(r => r.id === dayPlan.dinner.id), "Dinner");
            });

            icsContent += "END:VCALENDAR\n";

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meal_plan.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // --- New Calendar Functions ---
        function renderCalendar(year, month) {
            const today = new Date();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const numDaysInMonth = lastDay.getDate();

            monthYearDisplay.textContent = firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            calendarDaysGrid.innerHTML = '';

            const startDayOfWeek = firstDay.getDay();

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day-cell faded';
                calendarDaysGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.textContent = day;
                dayCell.classList.add('calendar-day-cell');

                const currentDay = new Date(year, month, day);

                if (currentDay.setHours(0, 0, 0, 0) < today.setHours(0, 0, 0, 0)) {
                    dayCell.classList.add('faded');
                } else {
                    dayCell.addEventListener('click', () => handleDayClick(currentDay));
                }
                
                updateCellState(dayCell, currentDay);
                calendarDaysGrid.appendChild(dayCell);
            }
        }

        function handleDayClick(date) {
            const normalizedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            if (startDate === null || normalizedDate.getTime() < startDate.getTime() || (startDate && endDate)) {
                startDate = normalizedDate;
                endDate = null;
            } else if (normalizedDate.getTime() >= startDate.getTime()) {
                endDate = normalizedDate;
            }
            renderCalendar(viewYear, viewMonth);
        }

        function updateCellState(cell, date) {
            const normalizedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            cell.classList.remove('selected', 'range-selected');
            
            if (startDate && endDate) {
                if (normalizedDate.getTime() === startDate.getTime() || normalizedDate.getTime() === endDate.getTime()) {
                    cell.classList.add('selected');
                } else if (normalizedDate.getTime() > startDate.getTime() && normalizedDate.getTime() < endDate.getTime()) {
                    cell.classList.add('range-selected');
                }
            } else if (startDate) {
                if (normalizedDate.getTime() === startDate.getTime()) {
                    cell.classList.add('selected');
                }
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            viewMonth--;
            if (viewMonth < 0) {
                viewMonth = 11;
                viewYear--;
            }
            renderCalendar(viewYear, viewMonth);
        });

        nextMonthBtn.addEventListener('click', () => {
            viewMonth++;
            if (viewMonth > 11) {
                viewMonth = 0;
                viewYear++;
            }
            renderCalendar(viewYear, viewMonth);
        });

        // Initial render
        renderCatalog();
        renderCalendar(viewYear, viewMonth);
    </script>
</body>
</html>